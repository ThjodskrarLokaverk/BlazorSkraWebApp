@page "/NotificationList/{id}"
@using BlazorSkraApp1.Components
@using BlazorSkraApp1.Data
@using BlazorSkraApp1.Services
@inject NavigationManager NavigationManager
@inject ICategoriesAssignmentsService catAssignService
@inject IFormsInfoService formservice
@inject IJSRuntime jsRuntime
@inject ICategoriesService catService

@if (categoriesAssignmentsList == null)
{
    <div class="d-flex justify-content-center">
        <div class="spinner-border" role="status">
            <span class="sr-only">Augnablik...</span>
        </div>
    </div>
}
else
{
    <div class="md-form mt-0 index-search">
        <input class="form-control" type="text" placeholder="Leita.." aria-label="Search" @bind-value='searchString' @bind-value:event="oninput" @onkeyup="NavigateToSearch">
        <a class="btn search-button"  href='/Search/@searchString'><i class="fas fa-search"></i> </a>
    </div>
    <div class="container">
        <AuthorizeView Roles="Admin">
        <div class="container">
        <button onclick="window.location.href='/FC/@category.CategoryId'" class="btn btn-success add-type">
            <i class="far fa-plus-square"></i>
                Bæta við eyðublaði
        </button>
        </div>
        </AuthorizeView>

        @if (categoriesAssignmentsList.Any())
        {
            <h3 class="notification-list-heading"> Flokkur: @category.CategoryName</h3>
        }
            <div class="row">
            @foreach (var categoryAssignment in categoriesAssignmentsList)
            {       
                
                <div class="col-md-4">
                    <AuthorizeView Roles="Admin">
                        <button class="btn btn-link btn-xs table-icon" data-toggle="modal">
                                <a id="a-tag" href="FormEdit/@categoryAssignment.FormsInfo.FormId">
                                    <i class="fas fa-pen sub-list-pen" title="Modifier"></i>
                                </a>
                        </button>
                        <button @onclick="(() => SelectCategoryAssignment(categoryAssignment))" class="btn btn-link btn-xs table-trash" data-toggle="modal" data-target="#confirmationModal">
                            <i class="fas fa-trash sub-list-trash" title="Trash"></i>
                        </button>
                    </AuthorizeView> 
                <div class="card card-list">
                    <img src="Images/form.svg" class="card-img-top" alt="notification form">
                    <div class="card-body body-list">
                        <h5 class="card-title title-list">@categoryAssignment.FormsInfo.FormName</h5>
                        <a href="/Notification/@categoryAssignment.FormsInfo.FormId" class="stretched-link"></a>
                    </div>
                
                </div>
            </div>
            }
            </div> 
             
            @if (!categoriesAssignmentsList.Any())
            // only displayed when there is no assignment in the category
            {
                 <AuthorizeView Roles="Admin">
                    <Authorized>
                        <h5 class="empty-state"> Það er ekkert eyðublað í þessum flokki. Bættu við eyðublaði með því að smella á <strong>"Bæta við eyðublaði</strong> uppi í vinstra horninu. </h5>
                    </Authorized>
                    <NotAuthorized> 
                        <h5 class="empty-state"> Það er ekkert eyðublað í þessum flokki. Vinsamlegast hafðu samband við stjórnanda ef þú telur vanta eyðublað í þennan flokk. </h5>
                    </NotAuthorized>
                </AuthorizeView>

                <img src="Images/meditation-bw.png" class="mediationIMG" alt="Empty state">
               
            }
            
    </div>
   

    <ConfirmationModalComponent OnClick="DeleteNotificationHandler">
        <CustomHeader>Eyða eyðublaði</CustomHeader>
        <CustomBody>Ertu viss um að þú viljir eyða eyðublaðinu @(selectedCategoryAssignment.FormsInfo.FormName)?</CustomBody>
        <CustomButtonText>Eyða</CustomButtonText>
    </ConfirmationModalComponent>
}

@code{
    [Parameter]
    public string id { get; set; }
    private int categoryId;
    List<CategoriesAssignments> categoriesAssignmentsList;
    Categories category = new Categories();
    CategoriesAssignments selectedCategoryAssignment;
    string searchString="";

    protected override async Task OnInitializedAsync()
    {
        //init selectedCategoryAssignment
        selectedCategoryAssignment = new CategoriesAssignments();
        selectedCategoryAssignment.FormsInfo = new FormsInfo();

        categoryId = Int16.Parse(id);

        //Get info about the category
        category = await catService.Get(categoryId);

        //Get a list of notifications assigned to the relevant category
        categoriesAssignmentsList = await catAssignService.Get(categoryId);

    }
    private void SelectCategoryAssignment(CategoriesAssignments categoryassignment)
    {
        selectedCategoryAssignment = categoryassignment;
    }



    protected async void DeleteNotificationHandler()
    {
        //Remove the notification/form from the list of notifications in this category
        await catAssignService.Delete(selectedCategoryAssignment);

        //Delete the notification/form from the database
        await formservice.Delete(selectedCategoryAssignment.FormId);

        //remove the notification/form from the list on this page
        categoriesAssignmentsList.Remove(selectedCategoryAssignment);

        //refresh UI
        StateHasChanged();
    }

    private void NavigateToSearch( KeyboardEventArgs eventArgs)
    {
        if (eventArgs.Key == "Enter" )
        {
            var Search = "Search/" + searchString;
            NavigationManager.NavigateTo(Search);
        }
    }
}